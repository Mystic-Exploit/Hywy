ุlocal WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Mystic Hub",
    Icon = "door-open",
    Author = "by .ftgs and .ftgs"
})

Window:EditOpenButton({
    Title = "Open UI",
    Icon = "monitor",
    CornerRadius = UDim.new(0, 16),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29")),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true
})

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

if not LocalPlayer.Character then
    LocalPlayer.CharacterAdded:Wait()
end
local MyHead = LocalPlayer.Character:WaitForChild("Head")

-- FOV & SilentAim
local Tab = Window:Tab({Title = "Combat", Icon = "crosshair"})
local FOVRadius = 150
local FOVEnabled = false
local sides = 20
local FOVLines = {}
for i = 1, sides do
    local line = Drawing.new("Line")
    line.Color = Color3.fromRGB(255, 255, 255)
    line.Thickness = 2
    line.Visible = FOVEnabled
    table.insert(FOVLines, line)
end
local targetLine = Drawing.new("Line")
targetLine.Color = Color3.fromRGB(255, 0, 0)
targetLine.Thickness = 2
targetLine.Visible = FOVEnabled

Tab:Toggle({
    Title = "Show FOV",
    Default = false,
    Callback = function(state)
        FOVEnabled = state
        for _, line in pairs(FOVLines) do
            line.Visible = state
        end
        targetLine.Visible = state
    end
})

local slider = Tab:Slider({
    Title = "FOV Size",
    Step = 1,
    Value = {Min = 50, Max = 1000, Default = FOVRadius},
    Callback = function(value)
        FOVRadius = tonumber(value) or 150
    end
})
slider.Callback(FOVRadius)

local SilentAimEnabled = true
local CurrentTarget
local head, aimPos

local GunNames = {"P226","MP5","M24","Draco","Glock","Sawnoff","Uzi","G3","C9","Hunting Rifle","Anaconda","AK47","Remington","Double Barrel"}
local GunLookup = {}
for _, name in pairs(GunNames) do GunLookup[name] = true end

local function GetClosestTargetInFOV()
    local closest
    local shortest = math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local screenPos, onScreen = Camera:WorldToViewportPoint(player.Character.Head.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
                if dist <= FOVRadius and dist < shortest then
                    shortest = dist
                    closest = player
                end
            end
        end
    end
    return closest
end

local function IsHoldingAllowedGun(args)
    local ok, weapon = pcall(function() return args[3] end)
    if not ok then return false end
    if typeof(weapon) == "Instance" and GunLookup[weapon.Name] then return true end
    for _, child in pairs(LocalPlayer.Character:GetChildren()) do
        if (child:IsA("Tool") or child:IsA("Model")) and GunLookup[child.Name] then
            return true
        end
    end
    return false
end

local send = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Send")
local oldFire
oldFire = hookfunction(send.FireServer, function(self, ...)
    local args = {...}
    if SilentAimEnabled and IsHoldingAllowedGun(args) then
        CurrentTarget = GetClosestTargetInFOV()
        if CurrentTarget and CurrentTarget.Character and CurrentTarget.Character:FindFirstChild("Head") then
            head = CurrentTarget.Character.Head
            aimPos = head.Position
            args[4] = CFrame.new(1/0,1/0,1/0,0/0,0/0,0/0,0/0,0/0,0/0,0/0,0/0,0/0)
            args[5] = {[1] = {[1] = {["Instance"]=head,["Position"]=aimPos}}}
        end
    end
    return oldFire(self, unpack(args))
end)

RunService.RenderStepped:Connect(function()
    if not FOVEnabled then return end
    local center = Camera.ViewportSize / 2
    local points = {}
    for i = 0, sides - 1 do
        local angle = math.rad(i * (360 / sides))
        local x = center.X + FOVRadius * math.cos(angle)
        local y = center.Y + FOVRadius * math.sin(angle)
        table.insert(points, Vector2.new(x, y))
    end
    for i = 1, sides do
        local nextIndex = i % sides + 1
        FOVLines[i].From = points[i]
        FOVLines[i].To = points[nextIndex]
    end
    local target = GetClosestTargetInFOV()
    if target and target.Character and target.Character:FindFirstChild("Head") then
        local targetHead = target.Character.Head
        local myScreen = Camera:WorldToViewportPoint(MyHead.Position)
        local targetScreen = Camera:WorldToViewportPoint(targetHead.Position)
        targetLine.From = Vector2.new(myScreen.X,myScreen.Y)
        targetLine.To = Vector2.new(targetScreen.X,targetScreen.Y)
        targetLine.Visible = true
    else
        targetLine.Visible = false
    end
end)

local TabESP = Window:Tab({Title="ESP", Icon="eye"})

-- ESP Name (เหมือนเดิม)
local ESPNameEnabled = false
local function createESP(player)
    if player == LocalPlayer then return end
    local function addBillboard(character)
        local head = character:WaitForChild("Head",5)
        if not head then return end
        local old = head:FindFirstChild("ESPBillboard")
        if old then old:Destroy() end
        if not ESPNameEnabled then return end
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESPBillboard"
        billboard.Adornee = head
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0,100,0,20)
        billboard.StudsOffset = Vector3.new(0,1.5,0)
        billboard.Parent = head
        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1,0,1,0)
        text.BackgroundTransparency = 1
        text.Text = player.DisplayName or player.Name
        text.TextColor3 = Color3.fromRGB(255,255,255)
        text.TextSize = 13
        text.Font = Enum.Font.Gotham
        text.TextStrokeTransparency = 0.9
        text.Parent = billboard
        player.CharacterRemoving:Connect(function()
            if billboard then billboard:Destroy() end
        end)
    end
    if player.Character then addBillboard(player.Character) end
    player.CharacterAdded:Connect(addBillboard)
end

TabESP:Toggle({
    Title="ESP Name",
    Default=false,
    Callback=function(state)
        ESPNameEnabled = state
        if state then
            for _,player in ipairs(Players:GetPlayers()) do createESP(player) end
            Players.PlayerAdded:Connect(createESP)
        else
            for _, player in ipairs(Players:GetPlayers()) do
                local head = player.Character and player.Character:FindFirstChild("Head")
                if head then
                    local b = head:FindFirstChild("ESPBillboard")
                    if b then b:Destroy() end
                end
            end
        end
    end
})

-- ESP Trace (เหมือนเดิม)
local Traces = {}
local TraceEnabled = false
local function createTrace(player)
    if player == LocalPlayer then return end
    if Traces[player] then return end
    local line = Drawing.new("Line")
    line.Color = Color3.fromRGB(0,170,255)
    line.Thickness = 2
    line.Visible = TraceEnabled
    Traces[player] = line
end
local function removeTrace(player)
    if Traces[player] then
        Traces[player]:Remove()
        Traces[player] = nil
    end
end

TabESP:Toggle({
    Title="ESP Trace",
    Default=false,
    Callback=function(state)
        TraceEnabled = state
        if state then
            for _,player in pairs(Players:GetPlayers()) do createTrace(player) end
            Players.PlayerAdded:Connect(createTrace)
            Players.PlayerRemoving:Connect(removeTrace)
        else
            for player,_ in pairs(Traces) do removeTrace(player) end
        end
    end
})

RunService.RenderStepped:Connect(function()
    if not TraceEnabled then return end
    local screenCenterTop = Vector2.new(Camera.ViewportSize.X/2,0)
    for player,line in pairs(Traces) do
        local character = player.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local pos, onScreen = Camera:WorldToViewportPoint(character.HumanoidRootPart.Position)
            line.Visible = onScreen
            if onScreen then
                line.From = screenCenterTop
                line.To = Vector2.new(pos.X,pos.Y)
            end
        else
            line.Visible = false
        end
    end
end)

-- ESP Highlight
local ESPHighlightEnabled = false
local Highlights = {}
local function healthToColor(hp,maxHp)
    if not maxHp or maxHp<=0 then maxHp=100 end
    if hp<=0 then return Color3.fromRGB(0,0,0) end
    if hp<=20 then return Color3.fromRGB(255,0,0)
    elseif hp<=50 then return Color3.fromRGB(255,209,0)
    else return Color3.fromRGB(0,255,0) end
end

local function createHighlight(player,character)
    if not character or player==LocalPlayer then return end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end

    local old = Highlights[player]
    if old and old.Instance then old.Instance:Destroy() end

    local highlight = Instance.new("Highlight")
    highlight.Name = "HealthESP_Highlight"
    highlight.Adornee = character
    highlight.Parent = game:GetService("CoreGui")
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = 0.6
    highlight.OutlineTransparency = 0.25
    highlight.Enabled = ESPHighlightEnabled

    local function updateColor()
        local hp = humanoid.Health or 0
        local maxHp = humanoid.MaxHealth or 100
        highlight.FillColor = healthToColor(hp,maxHp)
        highlight.OutlineColor = highlight.FillColor
    end

    local con1 = humanoid:GetPropertyChangedSignal("Health"):Connect(updateColor)
    local con2 = humanoid:GetPropertyChangedSignal("MaxHealth"):Connect(updateColor)
    local diedConn = humanoid.Died:Connect(updateColor)

    Highlights[player] = {Instance=highlight,Connections={con1,con2,diedConn}}
    updateColor()
end

local function cleanupHighlight(player)
    local record = Highlights[player]
    if record then
        for _,c in ipairs(record.Connections) do
            if c and c.Disconnect then pcall(function() c:Disconnect() end) end
        end
        pcall(function() if record.Instance then record.Instance:Destroy() end end)
        Highlights[player]=nil
    end
end

Players.PlayerAdded:Connect(function(player)
    if player==LocalPlayer then return end
    player.CharacterAdded:Connect(function(char) task.defer(function() if ESPHighlightEnabled then createHighlight(player,char) end end) end)
    if player.Character and ESPHighlightEnabled then createHighlight(player,player.Character) end
end)

Players.PlayerRemoving:Connect(function(player)
    cleanupHighlight(player)
end)

for _,player in pairs(Players:GetPlayers()) do
    if player~=LocalPlayer and player.Character and ESPHighlightEnabled then
        createHighlight(player,player.Character)
    end
end

TabESP:Toggle({
    Title="ESP Highlight",
    Default=false,
    Callback=function(state)
        ESPHighlightEnabled = state
        if state then
            for _,player in pairs(Players:GetPlayers()) do
                if player.Character then createHighlight(player,player.Character) end
            end
        else
            for player,_ in pairs(Highlights) do cleanupHighlight(player) end
        end
    end
})
-- Toggle UI
local ESPItemEnabled = false
TabESP:Toggle({
    Title = "ESP Item",
    Default = false,
    Callback = function(state)
        ESPItemEnabled = state
        ItemESP_Enabled = state
        updateAllPlayersESP()
    end
})

-- ตัวแปรและตารางที่ ESP Item ต้องใช้
local ItemESP_Enabled = false
local BillboardCache = {}
local ItemESP_UpdateConnections = {}
local WeaponDB = {}
local PreloadedImages = {}

local RARITY_COLORS = {
    ["Common"] = Color3.fromRGB(255, 255, 255),
    ["Uncommon"] = Color3.fromRGB(99, 255, 52),
    ["Rare"] = Color3.fromRGB(51, 170, 255),
    ["Epic"] = Color3.fromRGB(237, 44, 255),
    ["Legendary"] = Color3.fromRGB(255, 150, 0),
    ["Omega"] = Color3.fromRGB(255, 20, 51),
}

-- ฟังก์ชันสร้าง Unique Key ของไอเทม
local function generateUniqueKey(tool)
    if not tool or not tool:IsA("Tool") then return nil end
    local itemId = tool:GetAttribute("ItemId") or tool:GetAttribute("Id")
    if itemId and itemId ~= "" then
        return "ITEMID_" .. tostring(itemId)
    end

    local partsData = {}
    for _, part in ipairs(tool:GetDescendants()) do
        if part:IsA("SpecialMesh") and part.MeshId and part.MeshId ~= "" then
            table.insert(partsData, "MESH_"..part.MeshId.."|TEX_"..(part.TextureId or "NOTEX"))
        elseif part:IsA("MeshPart") and part.MeshId and part.MeshId ~= "" then
            table.insert(partsData, "MESH_"..part.MeshId.."|TEX_"..(part.TextureID or "NOTEX"))
        elseif part:IsA("Decal") and part.Texture and part.Texture ~= "" then
            table.insert(partsData, "DECAL_"..part.Texture)
        elseif part:IsA("Part") then
            table.insert(partsData, "PART_"..part.Name.."_"..part.Size.X.."x"..part.Size.Y.."x"..part.Size.Z)
        end
    end

    if #partsData > 0 then
        table.sort(partsData)
        return "MESHKEY_" .. table.concat(partsData, ";")
    end

    local displayName = tool:GetAttribute("DisplayName") or tool.Name
    local toolName = tool.Name
    local rarity = tool:GetAttribute("RarityName") or tool:GetAttribute("Rarity") or "Unknown"
    local imageId = tool:GetAttribute("ImageId") or "NOIMAGE"
    return "NAME_" .. displayName .. "_" .. toolName .. "_" .. rarity .. "_" .. imageId
end

-- ลงทะเบียนไอเทมทั้งหมด
local function registerItems(folder)
    for _, tool in ipairs(folder:GetDescendants()) do
        if not tool:IsA("Tool") then continue end
        local key = generateUniqueKey(tool)
        if not key then continue end

        local displayName = tool:GetAttribute("DisplayName") or tool.Name
        local imageId = tool:GetAttribute("ImageId") or "rbxassetid://7072725737"
        local rarity = tool:GetAttribute("RarityName") or tool:GetAttribute("Rarity") or "Common"

        WeaponDB[key] = {
            Name = displayName,
            Rarity = rarity,
            ImageId = imageId,
            ToolName = tool.Name,
            Key = key
        }

        if imageId and imageId ~= "" and not PreloadedImages[imageId] then
            PreloadedImages[imageId] = true
            task.spawn(function()
                pcall(function()
                    game:GetService("ContentProvider"):PreloadAsync({imageId})
                end)
            end)
        end
    end
end

-- โหลดไอเทมจาก ReplicatedStorage / StarterPack
pcall(function()
    local itemsFolder = ReplicatedStorage:WaitForChild("Items", 5)
    if itemsFolder then registerItems(itemsFolder) end
    for _, obj in ipairs(ReplicatedStorage:GetChildren()) do
        if obj:IsA("Folder") and (obj.Name:find("Weapon") or obj.Name:find("Item") or obj.Name:find("Tool")) then
            registerItems(obj)
        end
    end
    registerItems(game:GetService("StarterPack"))
end)

-- ฟังก์ชันดึงข้อมูลไอเทม
local function getWeaponInfo(tool)
    if not tool or not tool:IsA("Tool") then return nil end
    local key = generateUniqueKey(tool)
    return WeaponDB[key]
end

-- ฟังก์ชันสร้าง Billboard ให้ผู้เล่น
local function createBillboardForPlayer(player)
    if player == LocalPlayer or BillboardCache[player] then return end
    if not ESPItemEnabled then return end

    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- ลบของเดิมถ้ามี
    if BillboardCache[player] then
        BillboardCache[player]:Destroy()
        BillboardCache[player] = nil
    end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ItemESP"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 280, 0, 40)
    billboard.StudsOffset = Vector3.new(0, -6.5, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.Parent = hrp

    local container = Instance.new("Frame", billboard)
    container.Size = UDim2.new(1,0,1,0)
    container.BackgroundTransparency = 1

    -- ฟังก์ชันอัพเดตไอเทม
    local function updateESP()
        if not ItemESP_Enabled or not billboard.Parent then return end
        local currentTools = {}

        local function scan(folder)
            if not folder then return end
            for _, tool in ipairs(folder:GetChildren()) do
                if tool:IsA("Tool") and tool.Name ~= "Fists" then
                    local info = getWeaponInfo(tool)
                    if info then table.insert(currentTools, info) end
                end
            end
        end

        scan(char)
        local backpack = player:FindFirstChild("Backpack")
        if backpack then scan(backpack) end

        container:ClearAllChildren()
        local layout = Instance.new("UIListLayout")
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        layout.Padding = UDim.new(0,2)
        layout.Parent = container

        for i, info in ipairs(currentTools) do
            local text = Instance.new("TextLabel")
            text.Size = UDim2.new(1,0,0,14)
            text.BackgroundTransparency = 1
            text.TextScaled = true
            text.Font = Enum.Font.SourceSansBold
            text.TextColor3 = RARITY_COLORS[info.Rarity] or Color3.fromRGB(255,255,255)
            text.TextStrokeTransparency = 0
            text.Text = info.Name or info.ToolName or "Unknown"
            text.LayoutOrder = i
            text.Parent = container
        end
    end

    -- เชื่อมต่อ Event
    table.insert(ItemESP_UpdateConnections, char.ChildAdded:Connect(function(child)
        if child:IsA("Tool") then task.defer(updateESP) end
    end))
    table.insert(ItemESP_UpdateConnections, char.ChildRemoved:Connect(function(child)
        if child:IsA("Tool") then task.defer(updateESP) end
    end))

    updateESP()
    BillboardCache[player] = billboard
end

-- ฟังก์ชันอัพเดต ESP ให้ผู้เล่นทั้งหมด
function updateAllPlayersESP()
    for _, p in ipairs(Players:GetPlayers()) do
        if ESPItemEnabled then
            createBillboardForPlayer(p)
        else
            if BillboardCache[p] then
                BillboardCache[p]:Destroy()
                BillboardCache[p] = nil
            end
        end
    end
end

-- สร้าง ESP ให้ผู้เล่นทั้งหมดตอนรัน
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then createBillboardForPlayer(p) end
end

-- เชื่อมต่อผู้เล่นเพิ่ม/ออก
Players.PlayerAdded:Connect(function(p)
    if ESPItemEnabled then createBillboardForPlayer(p) end
end)
Players.PlayerRemoving:Connect(function(p)
    if BillboardCache[p] then
        BillboardCache[p]:Destroy()
        BillboardCache[p] = nil
    end
end))
